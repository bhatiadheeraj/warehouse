<template>
<div>
    <div class="page-content" ref="scrolled">
        <!--
        <div class="header">
            <b-container>
                <h2>Resources</h2>
                <p style="opacity: 0.7;">
                    You can run Apps on the following computing resources. To register your own resources, please see <a href="https://brainlife.io/docs/resources/register/" target="doc">Registering Resources</a>.
                </p>
            </b-container>
        </div>
        -->
        <div v-if="resources.mine.length > 0">
            <h4 class="header-sticky"><b-container>Private Resources</b-container></h4> 
            <b-container>
                <resource v-for="resource in resources.mine" :key="resource._id" class="resource" :resource="resource"/>
            </b-container>
            <br>
            <br>
        </div>

        <div v-if="resources.shared.length > 0">
            <h4 class="header-sticky"><b-container>Shared Resources</b-container></h4> 
            <b-container>
                <br>
                <p>
                    <small>The following resources are enabled on projects that you are member of.</small>
                </p>
                <resource v-for="resource in resources.shared" :key="resource._id" class="resource" :resource="resource"/>
            </b-container>
            <br>
            <br>
        </div>

        <div v-if="resources.public.length > 0">
            <h4 class="header-sticky"><b-container>Public Resources</b-container></h4> 
            <b-container>
                <br>
                <p>
                    <small>The following resources can be used by all members of brainlife.</small>
                </p>
                <resource v-for="resource in resources.public" :key="resource._id" class="resource" :resource="resource"/>
                <br>
                <p>
                    <small>To register your own resources, please see <a href="https://brainlife.io/docs/resources/register/" target="doc">Registering Resources</a>.</small>
                </p>
            </b-container>
            <br>
            <br>
        </div>

        <div v-if="organizations.length && resourcesWithOrg.length">
            <h4 class="header-sticky"><b-container>Organization Resources</b-container></h4> 
            <b-container>
                <template v-for="organization in organizations">
                    <br>
                    <h6>{{organization.name}}</h6>
                    <resource v-for="resource in resourcesWithOrg.filter(r=>r.organization == organization._id)" :key="resource._id" class="resource" :resource="resource"/>
                </template>
            </b-container>
            <br>
            <br>
        </div>

        <b-button v-if="config.hasRole('resource.create', 'amaretti')" class="button-fixed" @click="newresource">
            New Resource
        </b-button>
    </div><!--page-content-->
</div>
</template>

<script>

import Vue from 'vue'
import Router from 'vue-router'

import PerfectScrollbar from 'perfect-scrollbar'
import VueMarkdown from 'vue-markdown'

import pageheader from '@/components/pageheader'
import contact from '@/components/contact'
import tags from '@/components/tags'
import resource from '@/components/resource'

export default {
    components: { 
        pageheader, contact, tags, resource,
    },

    data () {
        return {
            resources: {
                mine: [],
                shared: [], //only admin should see this
                public: [], 
            },

            //for selected item
            apps: [], //apps that uses selected datatype
            adhoc_datatype_tags: [], //datatype tags associated with selected datatype

            //sample_task: null,
            sample_datasets: [],
            
            //editing: false, 
            config: Vue.config,
            organizations: [],
            resourcesWithOrg: [],
        }
    },

    mounted() {
        const find = {
            status: {$ne: "removed"},
        };
        //if(Vue.config.hasRole("admin")) find.user_id = null; //disable user filtering to show all

        this.$http.get(Vue.config.amaretti_api+'/resource', {params: {
            find: JSON.stringify(find),
            select: 'resource_id config.desc config.maxtask name citation status status_msg lastok_date active gids stats avatar organization'
        }}).then(res=>{
            this.resources.mine = [];
            this.resources.shared = [];
            this.resources.public = [];
            const usub = Vue.config.user.sub.toString();
            this.resourcesWithOrg = res.data.resources.filter(r=>r.organization);

            res.data.resources.filter(resource=>!resource.organization).forEach(r=>{
                if(r.gids.includes(1)) {
                    //public resource
                    this.resources.public.push(r);
                } else if(r.user_id == usub || (r.admins && r.admins.includes(usub))) {
                    //mine
                    this.resources.mine.push(r);
                } else {
                    //must be shared
                    this.resources.shared.push(r); 
                }
            });
        }).catch(console.error);

        this.loadOrganizations();
    },

    methods: {
        newresource() {
            this.$router.push('/resource/_/edit');
        },
        loadOrganizations() {
            this.$http.get(Vue.config.auth_api+'/organization', {params: {
                find: JSON.stringify({ 
                    removed: false 
                }),
            }}).then(res=>{
                this.organizations = res.data;
            }, error=>{
                console.error(error);
            });
        }
    }, //methods
}
</script>

<style scoped>
.page-content {
    top: 0px;
}
.page-content h2 {
    margin-bottom: 0px;
    padding: 10px 0px;
    font-size: 20pt;
}
.page-content h4 {
    padding: 15px 20px;
    background-color: white;
    opacity: 0.8;
    color: #999;
    font-size: 17pt;
    font-weight: bold;
}
.header {
    padding: 10px;
    background-color: white;
    border-bottom: 1px solid #eee;
}
h4.header-sticky {
    position: sticky;
    top: 0px;
    z-index: 2;
    box-shadow: 0 0 1px #ccc;
    padding-top: 12px;
    height: 50px;
}
.resource {
    border-bottom: 1px solid #0001;
}
.container p {
    margin-left: 20px;
}
</style>

